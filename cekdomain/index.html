<!doctype html>
<html lang="id">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Cek Domain Banyak - Fandirr</title>
  <style>
    :root{font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial;margin:0;padding:0}
    body{padding:24px;background:#f7f8fa;color:#111}
    h1{font-size:20px;margin:0 0 12px}
    .card{background:#fff;padding:16px;border-radius:8px;box-shadow:0 6px 20px rgba(0,0,0,.06);max-width:900px}
    textarea{width:100%;min-height:120px;padding:10px;border:1px solid #ddd;border-radius:6px;resize:vertical}
    .controls{display:flex;gap:8px;margin-top:8px}
    button{padding:8px 12px;border-radius:6px;border:0;cursor:pointer}
    button.primary{background:#0b74de;color:#fff}
    button.ghost{background:#eee}
    table{width:100%;border-collapse:collapse;margin-top:12px}
    th,td{padding:8px;border-bottom:1px solid #eee;text-align:left;font-size:13px}
    th{background:#fafafa}
    .small{font-size:12px;color:#666}
    .status-true{color:green;font-weight:600}
    .status-false{color:#c0392b;font-weight:600}
    .progress{margin-top:8px;font-size:13px}
  </style>
</head>
<body>
  <div class="card">
    <h1>Cek Domain Banyak</h1>
    <p class="small">Masukkan lebih dari satu domain. Pisahkan dengan baris baru, koma, atau spasi. Contoh: <code>wa.web.id</code></p>

    <textarea id="input" placeholder="Contoh:\nwa.web.id\nfandirr.web.id\nexample.com"></textarea>

    <div class="controls">
      <button id="check" class="primary">Cek Domain</button>
      <button id="clear" class="ghost">Kosongkan</button>
      <button id="export" class="ghost">Export CSV</button>
    </div>

    <div id="progress" class="progress small" aria-live="polite"></div>

    <table id="results" aria-live="polite">
      <thead>
        <tr><th>Domain</th><th>Available</th><th>Message</th><th>Raw status</th></tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>

  <script>
    const endpointBase = 'https://api.fandirr.my.id/search/domain?domain=';

    const $input = document.getElementById('input');
    const $check = document.getElementById('check');
    const $clear = document.getElementById('clear');
    const $export = document.getElementById('export');
    const $progress = document.getElementById('progress');
    const $tbody = document.querySelector('#results tbody');

    function parseDomains(raw) {
      if (!raw) return [];
      // split by newline, comma, or whitespace, then trim and filter empties
      return raw.split(/[\n,\s]+/)
        .map(s => s.trim())
        .filter(Boolean);
    }

    function addRow(domain, available, message, raw) {
      const tr = document.createElement('tr');
      const tdDomain = document.createElement('td'); tdDomain.textContent = domain;
      const tdAvail = document.createElement('td'); tdAvail.textContent = available;
      tdAvail.className = available === true || available === 'true' ? 'status-true' : 'status-false';
      const tdMsg = document.createElement('td'); tdMsg.textContent = message || '';
      const tdRaw = document.createElement('td'); tdRaw.textContent = raw || '';
      tr.append(tdDomain, tdAvail, tdMsg, tdRaw);
      $tbody.appendChild(tr);
    }

    function exportCSV() {
      const rows = Array.from($tbody.querySelectorAll('tr')).map(tr =>
        Array.from(tr.children).map(td => '"' + td.textContent.replace(/\"/g, '""') + '"').join(',')
      );
      if (rows.length === 0) {
        alert('Tidak ada hasil untuk diekspor');
        return;
      }
      const csv = ['"Domain","Available","Message","Raw"', ...rows].join('\n');
      const blob = new Blob([csv], {type: 'text/csv'});
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url; a.download = 'cek-domain-results.csv';
      document.body.appendChild(a); a.click(); a.remove();
      URL.revokeObjectURL(url);
    }

    // concurrency-limited runner
    async function checkDomains(domains, concurrency = 5) {
      $tbody.innerHTML = '';
      let completed = 0;
      $progress.textContent = `Menyiapkan ${domains.length} domain...`;

      const queue = domains.slice();
      const workers = Array.from({length: Math.min(concurrency, domains.length)}, () => worker());

      async function worker() {
        while (queue.length) {
          const domain = queue.shift();
          $progress.textContent = `Memeriksa ${domain} (${completed}/${domains.length})`;
          try {
            const res = await fetch(endpointBase + encodeURIComponent(domain));
            if (!res.ok) throw new Error('HTTP ' + res.status);
            const json = await res.json();
            // expected structure provided by user
            addRow(json.domain || domain, json.available, json.message || '', JSON.stringify(json));
          } catch (err) {
            addRow(domain, false, 'Gagal: ' + err.message, 'ERROR');
          }
          completed++;
          $progress.textContent = `Selesai ${completed}/${domains.length}`;
        }
      }

      await Promise.all(workers);
      $progress.textContent = `Selesai. ${completed}/${domains.length} domain diperiksa.`;
    }

    $check.addEventListener('click', async () => {
      const domains = parseDomains($input.value);
      if (domains.length === 0) {
        alert('Masukkan minimal 1 domain.');
        return;
      }
      // jalankan pemeriksaan
      try {
        await checkDomains(domains, 8);
      } catch (e) {
        console.error(e);
        alert('Terjadi kesalahan saat memeriksa. Cek console untuk detail.');
      }
    });

    $clear.addEventListener('click', () => {
      $input.value = '';
      $tbody.innerHTML = '';
      $progress.textContent = '';
    });

    $export.addEventListener('click', exportCSV);

    // small convenience: sample domains on load
    $input.value = 'wa.web.id\nfandirr.web.id\nexample.com';
  </script>
</body>
</html>
